<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-lemon"></i> Ingredients Management</h2>
        <hr>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-6 mb-2">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search ingredients..." 
                   ng-model="searchQuery" ng-change="search()">
            <button class="btn btn-outline-secondary" type="button" ng-click="search()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-6 mb-2">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Filter by tags (comma-separated)..." 
                   ng-model="tagSearch" ng-change="search()">
            <button class="btn btn-outline-secondary" type="button" ng-click="search()">
                <i class="fas fa-filter"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>{{ isEditing ? 'Edit' : 'Add New' }} Ingredient</h5>
            </div>
            <div class="card-body">
                <form ng-submit="saveIngredient()">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" ng-model="currentIngredient.name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" ng-model="currentIngredient.category" 
                                   placeholder="e.g., Spirit, Liqueur, Mixer">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" ng-model="currentIngredient.description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Bar Shelf Availability</label>
                        <select class="form-select" ng-model="currentIngredient.bar_shelf_availability">
                            <option value="Y">Yes</option>
                            <option value="N">No</option>
                        </select>
                    </div>
                    
                    <image-upload images="currentIngredient.images" 
                                  removed-images="currentIngredient.removed_images"
                                  api-url="{{apiUrl}}">
                    </image-upload>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" ng-model="newTag" placeholder="Add a tag...">
                            <button class="btn btn-outline-secondary" type="button" ng-click="addTag()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-secondary me-2 mb-2" ng-repeat="tag in currentIngredient.tags">
                                {{ tag }}
                                <i class="fas fa-times ms-1" ng-click="removeTag(tag)" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ isEditing ? 'Update' : 'Create' }}
                        </button>
                        <button type="button" class="btn btn-secondary" ng-click="resetForm()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Ingredients List -->
<div class="row">
    <div class="col-12">
        <h4>All Ingredients ({{ ingredients.length }})</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Tags</th>
                        <th>Bar Shelf</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="ingredient in ingredients">
                        <td>
                            <div class="item-image-gallery" ng-if="ingredient.images && ingredient.images.length > 0">
                                <img ng-src="{{getImageUrl(ingredient.images[0])}}" alt="{{ingredient.name}}">
                            </div>
                            <span ng-if="!ingredient.images || ingredient.images.length === 0" class="text-muted">No image</span>
                        </td>
                        <td><strong>{{ ingredient.name }}</strong></td>
                        <td>{{ ingredient.category || '-' }}</td>
                        <td>
                            <span ng-if="!needsTruncation(ingredient.description, 25)">{{ ingredient.description || '-' }}</span>
                            <span ng-if="needsTruncation(ingredient.description, 25)">
                                {{ truncateText(ingredient.description, 25) }}...
                                <a href="#" class="text-more-link" ng-click="showIngredientDetails(ingredient); $event.preventDefault()">more</a>
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info me-1" ng-repeat="tag in ingredient.tags">{{ tag }}</span>
                        </td>
                        <td class="text-center">
                            <input type="checkbox" 
                                   ng-model="ingredient.bar_shelf_availability" 
                                   ng-true-value="'Y'" 
                                   ng-false-value="'N'"
                                   ng-change="toggleBarShelf(ingredient)"
                                   class="form-check-input"
                                   style="cursor: pointer;">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" ng-click="editIngredient(ingredient)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" ng-click="deleteIngredient(ingredient.id)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr ng-if="ingredients.length === 0">
                        <td colspan="7" class="text-center text-muted">No ingredients found. Add one to get started!</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ingredient Details Modal -->
<div class="modal fade" id="ingredientDetailsModal" tabindex="-1" aria-labelledby="ingredientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="ingredientDetailsModalLabel">{{ selectedIngredient.name }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Ingredient Images -->
                <div class="mb-3" ng-if="selectedIngredient.images && selectedIngredient.images.length > 0">
                    <div class="d-flex flex-wrap gap-2">
                        <span style="text-align: center;">
                        <img ng-repeat="img in selectedIngredient.images" 
                             ng-src="{{getImageUrl(img)}}" 
                             alt="{{selectedIngredient.name}}" 
                             class="img-thumbnail"
                             style="border: 0; width: 150px; height: 150px; object-fit: cover;">
                        </span>
                    </div>
                </div>

                <!-- Ingredient Details -->
                <div class="mb-3" ng-if="selectedIngredient.category">
                    <h6><i class="fas fa-tag"></i> Category</h6>
                    <p>{{ selectedIngredient.category }}</p>
                </div>

                <div class="mb-3" ng-if="selectedIngredient.description">
                    <h6><i class="fas fa-info-circle"></i> Description</h6>
                    <p>{{ selectedIngredient.description }}</p>
                </div>

                <div class="mb-3">
                    <h6><i class="fas fa-wine-bottle"></i> Bar Shelf Availability</h6>
                    <p>{{ selectedIngredient.bar_shelf_availability === 'Y' ? 'Yes' : 'No' }}</p>
                </div>

                <!-- Ingredient Tags -->
                <div class="mb-3" ng-if="selectedIngredient.tags && selectedIngredient.tags.length > 0">
                    <h6><i class="fas fa-tags"></i> Tags</h6>
                    <div>
                        <span class="badge bg-info me-1 mb-1" ng-repeat="tag in selectedIngredient.tags track by $index">{{ tag }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
