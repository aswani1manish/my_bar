<div class="row">
    <div class="col-12">
        <h2 class="d-inline-block"><i class="fas fa-folder-open"></i> Collections Management</h2>
        <span ng-if="saveMessage" class="text-success ms-3">
            <i class="fas fa-check-circle"></i> {{ saveMessage }}
        </span>
        <span ng-if="saveError" class="text-danger ms-3">
            <i class="fas fa-exclamation-circle"></i> {{ saveError }}
        </span>
        <hr>
    </div>
</div>

<!-- Recipe Management Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-edit"></i> Manage Recipes in Collection</h5>
            </div>
            <div class="card-body">
                <!-- Collection Selector -->
                <div class="mb-3">
                    <label class="form-label"><strong>Select Collection:</strong></label>
                    <select class="form-select" ng-model="selectedCollectionId" ng-change="onCollectionSelect()">
                        <option value="">-- Select a Collection --</option>
                        <option ng-repeat="collection in collections" ng-value="collection.id">
                            {{collection.name}}
                        </option>
                    </select>
                </div>

                <!-- Recipes IN Collection Table -->
                <div ng-if="selectedCollectionId" class="mb-4">
                    <h6>Recipes in Collection ({{ filteredRecipesInCollection.length }}):</h6>
                    
                    <!-- Search for recipes in collection -->
                    <div class="mb-2">
                        <input type="text" class="form-control" placeholder="Search recipes in collection by name or ingredients..." 
                               ng-model="searchInCollection">
                    </div>
                    
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead class="table-success sticky-top">
                                <tr>
                                    <th style="width: 60px;">In Collection</th>
                                    <th style="width: 80px;">ID</th>
                                    <th style="width: 200px;">Name</th>
                                    <th>Ingredients</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="recipe in filteredRecipesInCollection" class="table-light">
                                    <td>
                                        <input type="checkbox" ng-model="recipeSelection[recipe.id]" 
                                               ng-change="onRecipeCheckboxChange(recipe.id)">
                                    </td>
                                    <td>{{recipe.id}}</td>
                                    <td>{{recipe.name}}</td>
                                    <td>{{getIngredientsList(recipe)}}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div ng-if="filteredRecipesInCollection.length === 0" class="alert alert-info">
                            No recipes in collection matching your search.
                        </div>
                    </div>
                </div>

                <!-- Recipes NOT in Collection Table -->
                <div ng-if="selectedCollectionId">
                    <h6>Recipes not in Collection ({{ filteredRecipesNotInCollection.length }}):</h6>
                    
                    <!-- Search for recipes not in collection -->
                    <div class="mb-2">
                        <input type="text" class="form-control" placeholder="Search available recipes by name or ingredients..." 
                               ng-model="searchNotInCollection">
                    </div>
                    
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover">
                            <thead class="table-secondary sticky-top">
                                <tr>
                                    <th style="width: 60px;">Add</th>
                                    <th style="width: 80px;">ID</th>
                                    <th style="width: 200px;">Name</th>
                                    <th>Ingredients</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="recipe in filteredRecipesNotInCollection">
                                    <td>
                                        <input type="checkbox" ng-model="recipeSelection[recipe.id]" 
                                               ng-change="onRecipeCheckboxChange(recipe.id)">
                                    </td>
                                    <td>{{recipe.id}}</td>
                                    <td>{{recipe.name}}</td>
                                    <td>{{getIngredientsList(recipe)}}</td>
                                </tr>
                            </tbody>
                        </table>
                        <div ng-if="filteredRecipesNotInCollection.length === 0" class="alert alert-info">
                            No available recipes matching your search.
                        </div>
                    </div>
                </div>

                <div ng-if="!selectedCollectionId" class="alert alert-info">
                    Please select a collection to manage its recipes.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-6 mb-2">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search collections..." 
                   ng-model="searchQuery" ng-change="search()">
            <button class="btn btn-outline-secondary" type="button" ng-click="search()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-6 mb-2">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Filter by tags (comma-separated)..." 
                   ng-model="tagSearch" ng-change="search()">
            <button class="btn btn-outline-secondary" type="button" ng-click="search()">
                <i class="fas fa-filter"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Form - COMMENTED OUT -->
<!-- <div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>{{ isEditing ? 'Edit' : 'Add New' }} Collection</h5>
            </div>
            <div class="card-body">
                <form ng-submit="saveCollection()">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" ng-model="currentCollection.name" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" ng-model="currentCollection.description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Recipes</label>
                        <div class="card">
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                <div class="form-check" ng-repeat="recipe in recipes">
                                    <input class="form-check-input" type="checkbox" 
                                           ng-model="selectedRecipes[recipe._id]" 
                                           id="recipe-{{ recipe._id }}">
                                    <label class="form-check-label" for="recipe-{{ recipe._id }}">
                                        {{ recipe.name }}
                                    </label>
                                </div>
                                <div ng-if="recipes.length === 0" class="text-muted">
                                    No recipes available. Create recipes first.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <image-upload images="currentCollection.images" 
                                  removed-images="currentCollection.removed_images"
                                  api-url="{{apiUrl}}">
                    </image-upload>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" ng-model="newTag" placeholder="Add a tag...">
                            <button class="btn btn-outline-secondary" type="button" ng-click="addTag()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-secondary me-2 mb-2" ng-repeat="tag in currentCollection.tags">
                                {{ tag }}
                                <i class="fas fa-times ms-1" ng-click="removeTag(tag)" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save"></i> {{ isEditing ? 'Update' : 'Create' }}
                        </button>
                        <button type="button" class="btn btn-secondary" ng-click="resetForm()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div> -->

<!-- Collections List -->
<div class="row">
    <div class="col-12">
        <h4>All Collections ({{ collections.length }})</h4>
        <div class="row">
            <div class="col-md-6 col-lg-3 mb-3" ng-repeat="collection in collections">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">{{ collection.name }}</h5>
                    </div>
                    <div class="card-body">
                        <!-- Collection Images -->
                        <div class="item-image-gallery mb-2" ng-if="collection.images && collection.images.length > 0">
                            <img ng-repeat="img in collection.images" ng-src="{{getImageUrl(img)}}" alt="{{collection.name}}" style="width: 80px; height: 80px;">
                        </div>
                        
                        <p class="card-text">
                            <span ng-if="!needsTruncation(collection.description, 25)">{{ collection.description || 'No description' }}</span>
                            <span ng-if="needsTruncation(collection.description, 25)">
                                {{ truncateText(collection.description, 25) }}...
                                <a href="#" class="text-more-link" ng-click="showCollectionDetails(collection); $event.preventDefault()">more</a>
                            </span>
                        </p>
                        
                        <h6>Recipes ({{ collection.recipe_ids.length }}):</h6>
                        
                        <p class="small" ng-repeat="recipeId in collection.recipe_ids track by $index"> 
                            {{ $index+1 }}. {{ getRecipeName(recipeId) }} - {{getIngredientNamesForRecipeId(recipeId)}}
                            </p>
                        
                        <div ng-if="collection.tags && collection.tags.length > 0">
                            <span class="badge bg-secondary me-1" ng-repeat="tag in collection.tags">{{ tag }}</span>
                        </div>
                    </div>
                    <!-- Edit/Delete Actions - COMMENTED OUT -->
                    <!-- <div class="card-footer">
                        <button class="btn btn-sm btn-warning me-1" ng-click="editCollection(collection)">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" ng-click="deleteCollection(collection._id)">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div> -->
                    <div class="card-footer">
                        <span class="text-muted">Read-only</span>
                    </div>
                </div>
            </div>
            <div class="col-12" ng-if="collections.length === 0">
                <div class="alert alert-info">No collections found. Create one to get started!</div>
            </div>
        </div>
    </div>
</div>

<!-- Collection Details Modal -->
<div class="modal fade" id="collectionDetailsModal" tabindex="-1" aria-labelledby="collectionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="collectionDetailsModalLabel">{{ selectedCollection.name }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Collection Images -->
                <div class="mb-3" ng-if="selectedCollection.images && selectedCollection.images.length > 0">
                    <div class="d-flex flex-wrap gap-2">
                        <span style="text-align: center;">
                        <img ng-repeat="img in selectedCollection.images" 
                             ng-src="{{getImageUrl(img)}}" 
                             alt="{{selectedCollection.name}}" 
                             class="img-thumbnail"
                             style="border: 0; width: 150px; height: 150px; object-fit: cover;">
                        </span>
                    </div>
                </div>

                <!-- Collection Description -->
                <div class="mb-3" ng-if="selectedCollection.description">
                    <h6><i class="fas fa-info-circle"></i> Description</h6>
                    <p>{{ selectedCollection.description }}</p>
                </div>

                <!-- Collection Recipes -->
                <div class="mb-3" ng-if="selectedCollection.recipe_ids && selectedCollection.recipe_ids.length > 0">
                    <h6><i class="fas fa-cocktail"></i> Recipes ({{ selectedCollection.recipe_ids.length }})</h6>
                    <ul class="list-group">
                        <li class="list-group-item" ng-repeat="recipeId in selectedCollection.recipe_ids track by $index">
                            <strong>{{ getRecipeName(recipeId) }}</strong>
                            <span class="text-muted"> - {{ getIngredientNamesForRecipeId(recipeId) }}</span>
                        </li>
                    </ul>
                </div>

                <!-- Collection Tags -->
                <div class="mb-3" ng-if="selectedCollection.tags && selectedCollection.tags.length > 0">
                    <h6><i class="fas fa-tags"></i> Tags</h6>
                    <div>
                        <span class="badge bg-info me-1 mb-1" ng-repeat="tag in selectedCollection.tags track by $index">{{ tag }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
